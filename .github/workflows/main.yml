name: ğŸš€ Sync to HuaweiCloud CodeArts (SSH)

on:
  push:
    branches: [main] # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest # ä½¿ç”¨ GitHub æ‰˜ç®¡çš„ Ubuntu è™šæ‹Ÿæœº

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºå½“å‰ GitHub ä»“åº“çš„ä»£ç 
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œè¿™å¯¹ git push æ˜¯å¿…é¡»çš„

      # æ­¥éª¤ 2: é…ç½® SSH å¯†é’¥å’Œ known_hosts (æ ¸å¿ƒæ­¥éª¤)
      - name: Setup SSH Environment
        run: |
          # åˆ›å»º .ssh ç›®å½•å¹¶è®¾ç½®æ­£ç¡®æƒé™
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # å°†ä» GitHub Secrets ä¸­è·å–çš„ç§é’¥å†™å…¥æ–‡ä»¶
          echo "${{ secrets.CODEARTS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          # è®¾ç½®ä¸¥æ ¼çš„æƒé™ï¼ŒSSH å®¢æˆ·ç«¯è¦æ±‚ç§é’¥å¿…é¡»æ˜¯ 600 æƒé™
          chmod 600 ~/.ssh/id_rsa

          # å°†åä¸ºäº‘ä»£ç æ‰˜ç®¡å¹³å°çš„ä¸»æœºæŒ‡çº¹æ·»åŠ åˆ° known_hosts
          # è¿™å¯ä»¥é¿å…é¦–æ¬¡è¿æ¥æ—¶å‡ºç° "The authenticity of host can't be established" çš„æç¤º
          ssh-keyscan codehub-cn-south-1.devcloud.huaweicloud.com >> ~/.ssh/known_hosts
          # åŒæ ·è®¾ç½® known_hosts æ–‡ä»¶çš„æ­£ç¡®æƒé™
          chmod 644 ~/.ssh/known_hosts

      # æ­¥éª¤ 3: é…ç½® Git ç”¨æˆ·ä¿¡æ¯ (å¯é€‰ä½†æ¨è)
      - name: Setup Git Config
        run: |
          git config --global user.name "ufun"
          git config --global user.email "274409508@qq.com"

      # æ­¥éª¤ 4: æ·»åŠ åä¸ºäº‘è¿œç¨‹ä»“åº“å¹¶æ¨é€ä»£ç 
      - name: Push to HuaweiCloud CodeArts
        run: |
          # æ·»åŠ åä¸ºäº‘ä»“åº“ä¸ºè¿œç¨‹ä»“åº“ï¼Œå‘½åä¸º ufun-website
          git remote add ufun-website $git@codehub-cn-south-1.devcloud.huaweicloud.com:4dbd6f39d1f0440e8544d9511d5ac29e/ufun-website.git
          # å¼ºåˆ¶æ¨é€åˆ°åä¸ºäº‘ä»“åº“çš„ main åˆ†æ”¯
          # --force é€‰é¡¹ç¡®ä¿ä¸¤è¾¹çš„å†å²ä¸€è‡´ï¼Œè¯·è°¨æ…ä½¿ç”¨
          git push --force ufun-website main:main
